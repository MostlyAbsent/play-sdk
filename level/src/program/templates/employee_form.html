<!DOCTYPE html>
<html lang="en" charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Search API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        h1 { color: #333; }
        form { margin-top: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"] { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        #response-container { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        #response-output { background-color: #e9e9e9; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Employee Search API</h1>
        <p>This API provides a search service. It's developers intend to allow searching by first name, or by last name, or both. And to allow any of Django's Filed Lookup operators to be used with the employee's name. See <a href="https://docs.djangoproject.com/en/5.2/ref/models/querysets/#field-lookups">Field Lookup operators</a> for a full list.</p>

        <div style="margin-bottom: 20px;overflow: auto;">
            <h2 style="float: left;">To get started try</h2>
            <button id="shexample" style="float: right;margin-top:20px;margin-right:5px;" type="button">Hide</button>
        </div>
        <div id="example" style="display: block;">
            <p>Search Filter:</p>
            <p style="font-family: 'Courier New', monospace;">firstName</p>
            <p>Search Query:</p>
            <p style="font-family: 'Courier New', monospace;">Robert</p>
            <h3>or</h3>
            <p>Search Filter:</p>
            <p style="font-family: 'Courier New', monospace;">lastName__startswith</p>
            <p>Search Query:</p>
            <p style="font-family: 'Courier New', monospace;">Sm</p>
        </div>

        <hr>

        <div style="margin-bottom: 20px;overflow: auto;">
            <h2 style="float: left;">To see the security flaw try</h2>
            <button id="shattack" style="float: right;margin-top:20px;margin-right:5px;" type="button">Show</button>
        </div>
        <div id="attack" style="display: none;">
            <p>Search Filter:</p>
            <p style="font-family: 'Courier New', monospace;">manager__user__password__startswith</p>
            <p>Search Query: </p>
            <p style="font-family: 'Courier New', monospace;">p</p>
            <p>This lets you see, and slowly derrive, the manager's password hash.</p>
        </div>

        <hr>

        <form id="employee-search-form">
            <label for="filter">Search Filter:</label>
            <input type="text" id="filter" name="filter">
            <label for="query">Search Query:</label>
            <input type="text" id="query" name="query">

            <button type="submit">Search Employees</button>
        </form>

        <div id="response-container">
            <h2>API Response:</h2>
            <pre id="response-output">Awaiting search...</pre>
        </div>
    </div>

    <script>
     document.getElementById('employee-search-form').addEventListener('submit', async function(event) {
         event.preventDefault();

            const filter = document.getElementById('filter').value.trim();
            const query = document.getElementById('query').value.trim();

            const responseOutput = document.getElementById('response-output');
            let payload;
            const request = `{ "${filter}" : "${query}"}`

            try {
                payload = JSON.parse(request);
                if (typeof payload !== 'object' || payload === null) {
                    throw new Error();
                }
            } catch (e) {
                responseOutput.textContent = "Invalid Json input.";
                responseOutput.classList.add("error");
                return;
            }

            if (Object.keys(payload).length === 0) {
                 responseOutput.textContent = "Enter a valid json string.";
                 responseOutput.classList.add('error');
                 return;
            }

            try {
                const response = await fetch('/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (response.ok) {
                    responseOutput.textContent = JSON.stringify(data, null, 2);
                    responseOutput.classList.remove('error');
                } else if (response.status == 422) {
                    const detail = data.details
                    responseOutput.innerHTML =
                        `${detail}\n\n
Search Filter must be a valid Django ORM Field Lookup.
See <a href="https://docs.djangoproject.com/en/5.2/topics/db/queries/#field-lookups">Field Lookups</a> for more information.`;
                    responseOutput.classList.add('error');
                } else {
                    responseOutput.textContent = `Error ${response.status}: ${JSON.stringify(data, null, 2)}`;
                    responseOutput.classList.add('error');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                responseOutput.textContent = `Network error: ${error.message}`;
                responseOutput.classList.add('error');
            }
        });

        // Function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

     document.getElementById('shexample')
             .addEventListener('click', async function(event) {
                 const examples = document.getElementById('example');

                 if (examples.style.display === 'block') {
                     examples.style.display = 'none';
                     this.textContent = 'Show';
                 } else {
                     examples.style.display = 'block';
                     this.textContent = 'Hide';
                 }
     })

     document.getElementById('shattack')
             .addEventListener('click', async function(event) {
                 const attack = document.getElementById('attack');

                 if (attack.style.display === 'block') {
                     attack.style.display = 'none';
                     this.textContent = 'Show';
                 } else {
                     attack.style.display = 'block';
                     this.textContent = 'Hide';
                 }
     })
    </script>
</body>
</html>
